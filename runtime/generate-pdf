#!/usr/bin/env bun
/**
 * PDF Generator CLI
 *
 * Simple command-line tool for generating PDFs from markdown.
 * Usage: generate-pdf <output-name> [title]
 *
 * Content is read from stdin.
 * The PDF is automatically saved as an artifact to the cloud.
 *
 * Examples:
 *   echo "# Hello World" | generate-pdf summary
 *   cat research.md | generate-pdf "Final Report" "Research Summary"
 */

import * as fs from "fs";
// Import from lakitu installation (script is copied to /usr/local/bin/)
import { markdownToDocNode, renderPdf } from "/home/user/lakitu/services/pdf/renderer";

// Cloud gateway config from environment
const CONVEX_URL = process.env.CONVEX_URL || "http://localhost:3210";
const SANDBOX_JWT = process.env.SANDBOX_JWT;
const CARD_ID = process.env.CARD_ID;
const GATEWAY_URL = process.env.GATEWAY_CONVEX_URL; // Cloud gateway

async function saveToCloud(name: string, pdfBase64: string): Promise<boolean> {
  const convexUrl = GATEWAY_URL || CONVEX_URL;
  const jwt = SANDBOX_JWT;
  const cardId = CARD_ID;

  if (!jwt || !cardId) {
    console.error("Warning: No JWT or CARD_ID - PDF will be saved locally only");
    return false;
  }

  try {
    const response = await fetch(`${convexUrl}/agent/call`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${jwt}`,
      },
      body: JSON.stringify({
        path: "features.kanban.artifacts.saveArtifactWithBackup",
        type: "action",
        args: {
          cardId,
          artifact: {
            name: `${name}.pdf`,
            type: "pdf",
            content: pdfBase64,
          },
        },
      }),
    });

    if (!response.ok) {
      console.error(`Cloud save failed: ${response.status}`);
      return false;
    }

    const result = await response.json();
    return result.ok === true;
  } catch (error) {
    console.error(`Cloud save error: ${error}`);
    return false;
  }
}

async function main() {
  const args = process.argv.slice(2);

  if (args.length < 1) {
    console.error("Usage: generate-pdf <output-name> [title]");
    console.error("Content is read from stdin");
    console.error("");
    console.error("Examples:");
    console.error("  echo '# My Report' | generate-pdf summary");
    console.error("  cat notes.md | generate-pdf 'Final Notes' 'Research Notes'");
    process.exit(1);
  }

  const outputName = args[0];
  const title = args[1];
  const outputPath = `/home/user/artifacts/${outputName}.pdf`;

  // Read content from stdin
  let content = "";
  for await (const chunk of Bun.stdin.stream()) {
    content += new TextDecoder().decode(chunk);
  }

  if (!content.trim()) {
    console.error("Error: No content provided. Pipe markdown content to stdin.");
    process.exit(1);
  }

  // Ensure output directory exists
  const outputDir = "/home/user/artifacts";
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  try {
    // Convert markdown to document structure and render PDF
    const docNode = markdownToDocNode(content, title);
    await renderPdf(docNode, { outputPath });

    // Read the generated PDF
    const pdfBuffer = fs.readFileSync(outputPath);
    const pdfBase64 = pdfBuffer.toString("base64");
    const size = pdfBuffer.length;

    // Save to cloud
    const cloudSaved = await saveToCloud(outputName, pdfBase64);

    console.log(`✓ PDF generated: ${outputPath} (${(size / 1024).toFixed(1)} KB)`);
    if (cloudSaved) {
      console.log(`✓ Saved to cloud as artifact: ${outputName}.pdf`);
    }

    // Output JSON for programmatic use
    console.log(JSON.stringify({
      success: true,
      path: outputPath,
      name: `${outputName}.pdf`,
      size,
      cloudSaved,
    }));

  } catch (error) {
    console.error(`Error: ${error instanceof Error ? error.message : error}`);
    process.exit(1);
  }
}

main();
